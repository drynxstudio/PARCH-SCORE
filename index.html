<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Padel League - Tournament Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Teko:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neon: '#CCFF00', 
                        electric: '#00F0FF',
                        dark: '#050505',
                        glass: 'rgba(20, 20, 25, 0.65)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        sport: ['Teko', 'sans-serif'],
                        digital: ['Orbitron', 'monospace'],
                    },
                    animation: {
                        'gradient-xy': 'gradient-xy 15s ease infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        'gradient-xy': {
                            '0%, 100%': { 'background-size': '400% 400%', 'background-position': 'left center' },
                            '50%': { 'background-size': '200% 200%', 'background-position': 'right center' },
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #fff; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .bg-live-gradient { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: linear-gradient(-45deg, #0f172a, #1e1b4b, #022c22, #000000); background-size: 400% 400%; animation: gradient-xy 15s ease infinite; }
        .bg-pattern-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 30px 30px; }
        .glass-panel { background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .glass-card { background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(5px); }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .btn-press:active { transform: scale(0.95); }
        
        /* Bracket Styles */
        .bracket-connector { position: absolute; right: -10px; top: 50%; width: 10px; height: 1px; background: #333; }
        .bracket-node { position: relative; }
        .bracket-node::after { content: ''; position: absolute; right: -20px; top: 25%; height: 50%; width: 1px; background: #444; display: none; }
        /* Simple tree logic managed via JS/Tailwind grid */
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <div class="bg-live-gradient"></div>
    <div class="bg-pattern-overlay"></div>

    <div id="modeSelection" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 backdrop-blur-xl bg-black/40">
        <div class="text-center mb-10 animate-float">
            <h1 class="text-6xl font-sport font-bold text-white tracking-wide drop-shadow-[0_0_15px_rgba(204,255,0,0.5)] leading-none">PADEL<br><span class="text-neon">SYSTEM</span></h1>
            <p class="text-sm text-electric font-bold tracking-[0.3em] uppercase mt-2">Tournament Master</p>
        </div>
        <div class="grid grid-cols-1 gap-6 w-full max-w-sm">
            <button onclick="selectMode('solo')" class="glass-panel p-6 rounded-2xl text-left hover:border-neon hover:bg-neon/10 transition group btn-press relative overflow-hidden">
                <div class="absolute -right-6 -bottom-6 text-white/5 text-8xl group-hover:text-neon/10 transition transform group-hover:scale-110"><i class="fas fa-user"></i></div>
                <div class="text-2xl font-sport font-bold text-white mb-1 uppercase tracking-wide group-hover:text-neon">SOLO RANK</div>
                <div class="text-xs text-gray-400">Individual • Random Partner</div>
            </button>
            <button onclick="selectMode('duo')" class="glass-panel p-6 rounded-2xl text-left hover:border-electric hover:bg-electric/10 transition group btn-press relative overflow-hidden">
                <div class="absolute -right-6 -bottom-6 text-white/5 text-8xl group-hover:text-electric/10 transition transform group-hover:scale-110"><i class="fas fa-users"></i></div>
                <div class="text-2xl font-sport font-bold text-white mb-1 uppercase tracking-wide group-hover:text-electric">DUO TEAM</div>
                <div class="text-xs text-gray-400">Fixed Partners • Team League</div>
            </button>
        </div>
    </div>

    <div id="mainApp" class="w-full max-w-md hidden flex-col h-screen relative z-10">
        
        <header class="px-6 pt-8 pb-4 flex justify-between items-end">
            <div class="w-full pr-4">
                <div class="flex items-center gap-2 mb-1">
                    <span id="modeBadge" class="text-[10px] bg-neon text-black font-black px-2 py-0.5 rounded uppercase tracking-widest">MODE</span>
                    <div class="h-px bg-white/20 flex-1"></div>
                </div>
                <h1 id="appTitle" contenteditable="true" onblur="saveTitle()" class="text-4xl font-sport font-bold italic text-white uppercase leading-[0.9] drop-shadow-md outline-none border-b border-transparent focus:border-white/50 transition-colors">PADEL CLUB</h1>
            </div>
            <button onclick="location.reload()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-gray-400 hover:text-white hover:border-neon transition btn-press"><i class="fas fa-power-off"></i></button>
        </header>

        <div class="px-6 mb-4">
            <nav class="glass-panel rounded-full p-1 flex justify-between shadow-2xl">
                <button onclick="switchTab('data')" id="tab-data" class="flex-1 py-3 rounded-full text-[10px] font-bold uppercase tracking-wider text-gray-400 transition-all btn-press bg-white/10 text-white shadow-lg">Data</button>
                <button onclick="switchTab('arena')" id="tab-arena" class="flex-1 py-3 rounded-full text-[10px] font-bold uppercase tracking-wider text-gray-400 transition-all btn-press">Arena</button>
                <button onclick="switchTab('cup')" id="tab-cup" class="flex-1 py-3 rounded-full text-[10px] font-bold uppercase tracking-wider text-gray-400 transition-all btn-press"><i class="fas fa-trophy text-neon mr-1"></i> CUP</button>
                <button onclick="switchTab('rank')" id="tab-rank" class="flex-1 py-3 rounded-full text-[10px] font-bold uppercase tracking-wider text-gray-400 transition-all btn-press">Rank</button>
            </nav>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-24 custom-scrollbar">

            <section id="view-data" class="fade-in-up">
                <div class="glass-panel p-5 rounded-2xl mb-6 border-l-4 border-neon">
                    <div class="flex justify-between items-center mb-4">
                        <label id="addLabel" class="text-xs text-neon font-sport font-bold uppercase tracking-wider text-xl">REGISTER NEW</label>
                        <span id="countDisplay" class="text-[10px] font-mono text-gray-400 bg-black/30 px-2 py-1 rounded">0 ENTRIES</span>
                    </div>
                    <div class="space-y-3">
                        <input type="text" id="inputName" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-sm text-white font-bold focus:outline-none focus:border-neon placeholder-gray-600" placeholder="Name...">
                        <div id="duoInputs" class="hidden grid grid-cols-2 gap-2">
                            <input type="text" id="inputP1" class="bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs text-white focus:border-electric placeholder-gray-600" placeholder="Player 1">
                            <input type="text" id="inputP2" class="bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs text-white focus:border-electric placeholder-gray-600" placeholder="Player 2">
                        </div>
                        <button onclick="addEntry()" class="w-full bg-gradient-to-r from-neon to-green-400 text-black font-sport font-bold text-xl py-2 rounded-xl uppercase tracking-wider hover:brightness-110 btn-press">ADD</button>
                    </div>
                </div>
                <div id="dataList" class="space-y-2 pb-10"></div>
            </section>

            <section id="view-arena" class="hidden fade-in-up">
                <div id="matchSetup" class="glass-panel p-6 rounded-3xl text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-electric via-purple-500 to-neon"></div>
                    <button onclick="autoDraft()" class="mx-auto mb-6 bg-gray-800/80 border border-gray-600 text-white text-[10px] font-bold uppercase px-4 py-2 rounded-full hover:border-electric hover:text-electric transition shadow-lg btn-press flex items-center gap-2">
                        <i class="fas fa-magic text-electric"></i> Fair Auto-Draft
                    </button>
                    <h3 class="text-2xl font-sport font-bold text-white mb-6 uppercase tracking-wide">FRIENDLY MATCH</h3>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="space-y-2 bg-black/20 p-3 rounded-xl border border-white/5">
                            <div class="text-xs text-electric font-bold font-sport tracking-wider text-xl">TEAM A</div>
                            <select id="selectA" class="w-full bg-black border border-gray-700 rounded-lg p-2 text-xs text-white font-bold"></select>
                            <select id="selectA2" class="hidden w-full bg-black border border-gray-700 rounded-lg p-2 text-xs text-white font-bold"></select>
                        </div>
                        <div class="space-y-2 bg-black/20 p-3 rounded-xl border border-white/5">
                            <div class="text-xs text-pink-500 font-bold font-sport tracking-wider text-xl">TEAM B</div>
                            <select id="selectB" class="w-full bg-black border border-gray-700 rounded-lg p-2 text-xs text-white font-bold"></select>
                            <select id="selectB2" class="hidden w-full bg-black border border-gray-700 rounded-lg p-2 text-xs text-white font-bold"></select>
                        </div>
                    </div>
                    <button onclick="startMatch('friendly')" class="w-full bg-white text-black font-sport font-bold text-2xl py-3 rounded-xl tracking-wider hover:bg-gray-200 transition btn-press shadow-xl">START MATCH</button>
                </div>
                <div class="mt-8">
                     <h4 class="text-xs text-gray-500 font-bold font-sport uppercase tracking-widest text-xl mb-3 border-b border-gray-800 pb-2">RECENT MATCHES</h4>
                     <div id="matchHistory" class="space-y-2"></div>
                </div>
            </section>

            <section id="view-cup" class="hidden fade-in-up">
                
                <div id="cupSetup" class="glass-panel p-6 rounded-3xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-neon via-yellow-400 to-neon"></div>
                    <div class="text-center mb-6">
                        <i class="fas fa-trophy text-4xl text-yellow-400 mb-2 drop-shadow-lg"></i>
                        <h3 class="text-3xl font-sport font-bold text-white uppercase tracking-wide">TOURNAMENT SETUP</h3>
                    </div>

                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Cup Name</label>
                        <input type="text" id="cupName" value="Padel Cup 2026" class="w-full bg-black/40 border border-gray-700 rounded-lg px-3 py-2 text-white font-bold text-sm">
                    </div>

                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Format</label>
                        <div class="grid grid-cols-2 gap-2 mt-1">
                            <button onclick="setCupType('group')" id="btnTypeGroup" class="bg-neon text-black py-2 rounded text-xs font-bold border border-gray-700">LEAGUE (GROUP)</button>
                            <button onclick="setCupType('ko')" id="btnTypeKo" class="bg-gray-800 text-gray-400 py-2 rounded text-xs font-bold border border-gray-700">KNOCKOUT</button>
                        </div>
                    </div>

                    <div id="configGroup" class="mb-6">
                         <label class="text-[10px] font-bold text-gray-500 uppercase">Total Groups</label>
                         <div class="flex gap-2 mt-1">
                             <button onclick="setCupSize(1)" class="flex-1 bg-gray-800 py-2 rounded text-xs font-bold text-white border border-gray-600 hover:bg-gray-700">1 Group</button>
                             <button onclick="setCupSize(2)" class="flex-1 bg-gray-800 py-2 rounded text-xs font-bold text-white border border-gray-600 hover:bg-gray-700">2 Groups</button>
                         </div>
                    </div>

                    <div id="configKo" class="mb-6 hidden">
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Bracket Size</label>
                        <div class="flex gap-2 mt-1">
                            <button onclick="setCupSize(4)" class="flex-1 bg-gray-800 py-2 rounded text-xs font-bold text-white border border-gray-600 hover:bg-gray-700">Top 4 (Semis)</button>
                            <button onclick="setCupSize(8)" class="flex-1 bg-gray-800 py-2 rounded text-xs font-bold text-white border border-gray-600 hover:bg-gray-700">Top 8 (Quarters)</button>
                        </div>
                        <p class="text-[9px] text-gray-500 mt-2 italic">*Requires exactly 4 or 8 participants selected.</p>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-end mb-2">
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Participants</label>
                            <span id="selectedCount" class="text-[10px] text-neon font-mono">0 Selected</span>
                        </div>
                        <div id="cupParticipants" class="max-h-40 overflow-y-auto bg-black/30 rounded-lg p-2 space-y-1 custom-scrollbar"></div>
                    </div>

                    <button onclick="createTournament()" class="w-full bg-gradient-to-r from-yellow-500 to-yellow-300 text-black font-sport font-bold text-2xl py-3 rounded-xl tracking-wider hover:brightness-110 btn-press shadow-xl">
                        CREATE DRAW
                    </button>
                </div>

                <div id="cupActive" class="hidden">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-3">
                        <div>
                            <h2 id="activeCupName" class="text-xl font-sport font-bold text-yellow-400 uppercase tracking-wide"></h2>
                            <span id="activeCupType" class="text-[9px] bg-gray-800 px-2 py-0.5 rounded text-gray-400 uppercase font-bold"></span>
                        </div>
                        <button onclick="deleteCup()" class="text-[10px] text-red-500 border border-red-900 px-3 py-1 rounded hover:bg-red-900/20 font-bold">RESET</button>
                    </div>

                    <div id="cupContent" class="space-y-6"></div>
                </div>
            </section>

            <section id="view-rank" class="hidden fade-in-up">
                <div id="mvpHeader" class="hidden mb-6 relative group cursor-pointer" onclick="openExport()">
                    <div class="absolute inset-0 bg-gradient-to-r from-yellow-600 to-yellow-300 rounded-xl opacity-20 group-hover:opacity-30 transition blur-lg"></div>
                    <div class="glass-panel p-4 rounded-xl flex justify-between items-center border border-yellow-500/30 relative">
                        <div>
                            <div class="text-[10px] text-yellow-400 font-bold uppercase tracking-widest mb-1"><i class="fas fa-crown mr-1"></i> LEAGUE LEADER</div>
                            <div class="text-2xl font-sport font-bold text-white leading-none" id="leaderName">PLAYER NAME</div>
                        </div>
                        <div class="bg-yellow-400 text-black w-10 h-10 rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(250,204,21,0.5)] group-hover:scale-110 transition">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                </div>
                <div class="glass-panel rounded-2xl overflow-hidden p-0">
                    <table class="w-full text-left">
                        <thead class="bg-black/30 text-[10px] text-gray-400 font-bold uppercase tracking-widest">
                            <tr><th class="p-4 text-center">#</th><th class="p-4">Entity</th><th class="p-4 text-center">P</th><th class="p-4 text-center text-neon">W</th><th class="p-4 text-right">Diff</th></tr>
                        </thead>
                        <tbody id="rankBody" class="text-xs font-mono text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </section>

        </div>
    </div>

    <div id="scoreboardOverlay" class="fixed inset-0 z-[60] bg-black/95 hidden flex flex-col p-4 backdrop-blur-xl">
        <div class="glass-panel rounded-3xl overflow-hidden border border-white/10 relative shadow-2xl mt-10">
            <div class="bg-black/80 p-3 flex justify-between items-center border-b border-gray-800">
                <div class="flex items-center gap-2">
                    <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>
                    <span class="text-[10px] font-bold text-white uppercase tracking-widest">LIVE</span>
                </div>
                <button onclick="endMatch()" class="text-[10px] font-bold text-black bg-white px-3 py-1 rounded hover:bg-gray-200 btn-press">FINISH</button>
            </div>
            <div id="gpAlert" class="hidden bg-gradient-to-r from-yellow-600 via-yellow-400 to-yellow-600 text-black text-center py-1 text-xs font-black uppercase tracking-widest animate-pulse">GOLDEN POINT</div>
            <div class="p-6 flex justify-between items-center bg-black/40">
                <div class="text-center w-5/12">
                    <div class="text-6xl font-digital font-bold text-electric tracking-tighter" id="scoreDispA">0</div>
                    <div class="text-xs font-bold text-gray-300 mt-2 truncate uppercase" id="nameDispA">TEAM A</div>
                    <div class="inline-block bg-gray-800 rounded px-2 py-0.5 mt-2"><div class="text-[9px] font-mono text-gray-400">GAMES: <span id="gamesDispA" class="text-white font-bold text-sm">0</span></div></div>
                </div>
                <div class="text-gray-700 font-thin text-5xl opacity-30">/</div>
                <div class="text-center w-5/12">
                    <div class="text-6xl font-digital font-bold text-pink-500 tracking-tighter" id="scoreDispB">0</div>
                    <div class="text-xs font-bold text-gray-300 mt-2 truncate uppercase" id="nameDispB">TEAM B</div>
                    <div class="inline-block bg-gray-800 rounded px-2 py-0.5 mt-2"><div class="text-[9px] font-mono text-gray-400">GAMES: <span id="gamesDispB" class="text-white font-bold text-sm">0</span></div></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-1 bg-black/50 p-1">
                <button onclick="point('A')" class="py-10 bg-gray-900/50 border-r border-gray-800 flex flex-col items-center hover:bg-electric/10"><span class="text-[10px] text-gray-500 font-bold uppercase">POINT BLUE</span><i class="fas fa-plus text-white mt-1 text-2xl"></i></button>
                <button onclick="point('B')" class="py-10 bg-gray-900/50 flex flex-col items-center hover:bg-pink-500/10"><span class="text-[10px] text-gray-500 font-bold uppercase">POINT RED</span><i class="fas fa-plus text-white mt-1 text-2xl"></i></button>
            </div>
        </div>
        <button onclick="undo()" class="w-full mt-4 py-4 text-xs text-gray-500 font-bold uppercase tracking-widest hover:text-white bg-gray-900 rounded-xl"><i class="fas fa-undo mr-2"></i> UNDO</button>
        <button onclick="closeScoreboard()" class="mt-auto text-xs text-red-500 font-bold uppercase py-4">CANCEL MATCH</button>
    </div>

    <div id="exportModal" class="hidden fixed inset-0 z-[60] bg-black/95 flex flex-col items-center justify-center p-4 backdrop-blur-xl">
        <div id="cardCanvas" class="w-[300px] h-[533px] bg-black relative flex flex-col border border-gray-800 overflow-hidden shadow-2xl">
             <div id="cardPhoto" class="absolute inset-0 bg-cover bg-center opacity-60 scale-105"></div>
             <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>
             <div class="relative z-10 p-6 flex flex-col h-full justify-between">
                 <div class="flex justify-between items-start">
                     <div>
                         <div id="cardAppTitle" class="text-3xl font-sport font-bold text-white italic leading-[0.85] uppercase break-words w-48 drop-shadow-lg">PADEL</div>
                         <div class="w-10 h-1 bg-neon mt-2"></div>
                     </div>
                     <div class="bg-white text-black text-[10px] font-bold px-2 py-1 uppercase tracking-widest transform rotate-3">NO. 1</div>
                 </div>
                 <div class="mb-4">
                     <div class="flex items-center gap-2 mb-2"><i class="fas fa-trophy text-yellow-400 text-lg"></i><div class="text-[10px] text-yellow-400 font-bold uppercase tracking-widest">LEAGUE MVP</div></div>
                     <h2 class="text-5xl font-sport font-bold text-white uppercase leading-[0.85] break-words drop-shadow-xl" id="expName">NAME</h2>
                     <div class="grid grid-cols-3 gap-2 mt-6 border-t border-white/20 pt-4 backdrop-blur-sm bg-black/20 rounded-xl p-2">
                         <div class="text-center"><div class="text-2xl font-digital font-bold text-neon" id="expWin">0</div><div class="text-[8px] text-gray-400 uppercase tracking-widest font-bold">WINS</div></div>
                         <div class="text-center border-l border-white/10"><div class="text-2xl font-digital font-bold text-white" id="expMatch">0</div><div class="text-[8px] text-gray-400 uppercase tracking-widest font-bold">MATCHES</div></div>
                         <div class="text-center border-l border-white/10"><div class="text-2xl font-digital font-bold text-electric" id="expRate">0%</div><div class="text-[8px] text-gray-400 uppercase tracking-widest font-bold">RATE</div></div>
                     </div>
                 </div>
             </div>
        </div>
        <div class="flex gap-2 mt-8 w-[300px]">
            <label class="flex-1 bg-gray-800 text-white py-3 rounded-xl text-[10px] font-bold uppercase tracking-widest text-center cursor-pointer hover:bg-gray-700 transition btn-press"><i class="fas fa-upload mr-1"></i> PHOTO<input type="file" class="hidden" onchange="loadPhoto(this)"></label>
            <button onclick="downloadCard()" class="flex-[2] bg-white text-black py-3 rounded-xl text-[10px] font-bold uppercase tracking-widest hover:bg-gray-200 transition btn-press"><i class="fas fa-download mr-1"></i> SAVE CARD</button>
            <button onclick="closeExport()" class="w-12 bg-red-900/50 rounded-xl text-red-500 font-bold border border-red-900"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <script>
        let MODE='solo', db={solo:{players:[],matches:[]},duo:{teams:[],matches:[]}, cup:null}, liveMatch=null, POINTS=[0,15,30,40], cupSize=1, cupType='group';

        window.onload=()=>{
            const d=localStorage.getItem('padel_pro_db_v3'); if(d) db=JSON.parse(d);
            const t=localStorage.getItem('padel_pro_title_v3'); if(t) document.getElementById('appTitle').innerText=t;
        };
        function saveAll(){localStorage.setItem('padel_pro_db_v3',JSON.stringify(db));}
        function saveTitle(){localStorage.setItem('padel_pro_title_v3',document.getElementById('appTitle').innerText);}

        // NAV
        function selectMode(m){ MODE=m; document.getElementById('modeSelection').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden'); document.getElementById('mainApp').classList.add('flex'); document.getElementById('modeBadge').innerText=MODE==='solo'?'SOLO RANK':'DUO TEAM'; document.getElementById('addLabel').innerText=MODE==='solo'?'NEW PLAYER':'NEW TEAM'; document.getElementById('inputName').placeholder=MODE==='solo'?'Name...':'Team...'; if(MODE==='duo'){ document.getElementById('duoInputs').classList.remove('hidden'); document.getElementById('selectA2').classList.add('hidden'); document.getElementById('selectB2').classList.add('hidden'); } else { document.getElementById('duoInputs').classList.add('hidden'); document.getElementById('selectA2').classList.remove('hidden'); document.getElementById('selectB2').classList.remove('hidden'); } renderAll(); }
        function switchTab(t){ ['data','arena','cup','rank'].forEach(x=>{document.getElementById('view-'+x).classList.add('hidden');document.getElementById('tab-'+x).classList.remove('bg-white/10','text-white','shadow-lg');document.getElementById('tab-'+x).classList.add('text-gray-400');}); document.getElementById('view-'+t).classList.remove('hidden'); document.getElementById('tab-'+t).classList.add('bg-white/10','text-white','shadow-lg'); document.getElementById('tab-'+t).classList.remove('text-gray-400'); if(t==='cup') renderCup(); }
        function renderAll(){renderList();populateSelects();renderRank();renderHistory();renderCup();}

        // DB
        function addEntry(){
            const n=document.getElementById('inputName').value.trim(); if(!n)return;
            const l=MODE==='solo'?db.solo.players:db.duo.teams;
            if(MODE==='solo') l.push({id:Date.now(),name:n,matches:0,won:0,gamesWon:0,gamesLost:0});
            else { const p1=document.getElementById('inputP1').value, p2=document.getElementById('inputP2').value; if(!p1||!p2)return; l.push({id:Date.now(),name:n,p1:p1,p2:p2,matches:0,won:0,gamesWon:0,gamesLost:0}); }
            saveAll(); renderAll(); document.getElementById('inputName').value=''; document.getElementById('inputP1').value=''; document.getElementById('inputP2').value='';
        }
        function renderList(){
            const d=document.getElementById('dataList'); d.innerHTML='';
            const l=MODE==='solo'?db.solo.players:db.duo.teams;
            document.getElementById('countDisplay').innerText=l.length+" ENTRIES";
            // Checkbox for Cup
            const cupList = document.getElementById('cupParticipants'); cupList.innerHTML='';
            l.slice().reverse().forEach(x=>{
                // Main List
                const el=document.createElement('div'); el.className='glass-card p-3 rounded-xl flex justify-between items-center group mb-2 hover:bg-white/5 transition';
                el.innerHTML=`<div><div class="font-bold text-sm text-white tracking-wide">${x.name}</div>${MODE==='duo'?`<div class="text-[9px] text-gray-500">${x.p1}&${x.p2}</div>`:''}</div><button onclick="delEntry(${x.id})" class="text-gray-600 hover:text-red-500 opacity-50 group-hover:opacity-100"><i class="fas fa-trash"></i></button>`;
                d.appendChild(el);
                // Cup List Checkbox
                const ck = document.createElement('label'); ck.className='flex items-center gap-2 text-xs text-gray-300 p-2 border-b border-gray-800 hover:bg-white/5 cursor-pointer';
                ck.innerHTML = `<input type="checkbox" value="${x.id}" onchange="updateSelectedCount()" class="accent-neon w-4 h-4"> ${x.name}`;
                cupList.appendChild(ck);
            });
        }
        function delEntry(id){ if(!confirm("Delete?"))return; if(MODE==='solo') db.solo.players=db.solo.players.filter(x=>x.id!==id); else db.duo.teams=db.duo.teams.filter(x=>x.id!==id); saveAll(); renderAll(); }
        function updateSelectedCount() { document.getElementById('selectedCount').innerText = document.querySelectorAll('#cupParticipants input:checked').length + " Selected"; }

        // ARENA
        function populateSelects(){
            const l=MODE==='solo'?db.solo.players:db.duo.teams;
            const s=MODE==='solo'?['selectA','selectA2','selectB','selectB2']:['selectA','selectB'];
            s.forEach(id=>{ const el=document.getElementById(id); el.innerHTML='<option value="">Select...</option>'; l.forEach(x=>el.innerHTML+=`<option value="${x.id}">${x.name}</option>`); });
        }
        function autoDraft(){
            const l=MODE==='solo'?db.solo.players:db.duo.teams;
            if(l.length<(MODE==='solo'?4:2))return alert("Not enough entries");
            const pool=[...l].sort((a,b)=>(a.matches!==b.matches)?a.matches-b.matches:0.5-Math.random());
            if(MODE==='solo'){const p=pool.slice(0,4).sort(()=>0.5-Math.random()); document.getElementById('selectA').value=p[0].id; document.getElementById('selectA2').value=p[1].id; document.getElementById('selectB').value=p[2].id; document.getElementById('selectB2').value=p[3].id;}
            else {const p=pool.slice(0,2).sort(()=>0.5-Math.random()); document.getElementById('selectA').value=p[0].id; document.getElementById('selectB').value=p[1].id;}
        }
        function startMatch(type, matchId=null){
            let nA,nB,iA,iB;
            if(type==='friendly'){
                if(MODE==='solo'){
                    const a1=document.getElementById('selectA').value, a2=document.getElementById('selectA2').value, b1=document.getElementById('selectB').value, b2=document.getElementById('selectB2').value;
                    if(!a1||!a2||!b1||!b2 || new Set([a1,a2,b1,b2]).size!==4) return alert("Invalid selection");
                    const gn=(id)=>db.solo.players.find(x=>x.id==id).name;
                    nA=`${gn(a1)}/${gn(a2)}`; nB=`${gn(b1)}/${gn(b2)}`; iA=[a1,a2]; iB=[b1,b2];
                } else {
                    const a=document.getElementById('selectA').value, b=document.getElementById('selectB').value;
                    if(!a||!b||a===b) return alert("Invalid selection");
                    nA=db.duo.teams.find(x=>x.id==a).name; nB=db.duo.teams.find(x=>x.id==b).name; iA=[a]; iB=[b];
                }
            } else {
                // CUP MATCH (GROUP or KO)
                let match = null;
                if(db.cup.format === 'group') {
                    const group = db.cup.data.find(g => g.matches.find(m => m.id === matchId));
                    match = group.matches.find(m => m.id === matchId);
                } else {
                    match = db.cup.data.find(m => m.id === matchId);
                }
                nA=match.tA_name; nB=match.tB_name; iA=[match.tA_id]; iB=[match.tB_id];
            }
            liveMatch = { active:true, type:type, tmId:matchId, iA:iA, iB:iB, nA:nA, nB:nB, sA:0, sB:0, gA:0, gB:0, hist:[] };
            updateScoreUI();
            document.getElementById('scoreboardOverlay').classList.remove('hidden');
        }
        function closeScoreboard(){ document.getElementById('scoreboardOverlay').classList.add('hidden'); liveMatch=null; }
        function point(s){ liveMatch.hist.push({sA:liveMatch.sA,sB:liveMatch.sB,gA:liveMatch.gA,gB:liveMatch.gB}); const m=s==='A'?liveMatch.sA:liveMatch.sB, o=s==='A'?liveMatch.sB:liveMatch.sA; if((m===3&&o===3)||m===3){if(s==='A')liveMatch.gA++;else liveMatch.gB++; liveMatch.sA=0; liveMatch.sB=0;}else{if(s==='A')liveMatch.sA++;else liveMatch.sB++;} updateScoreUI(); }
        function undo(){ if(liveMatch.hist.length){const p=liveMatch.hist.pop(); liveMatch.sA=p.sA; liveMatch.sB=p.sB; liveMatch.gA=p.gA; liveMatch.gB=p.gB; updateScoreUI();} }
        function updateScoreUI(){
            document.getElementById('nameDispA').innerText=liveMatch.nA; document.getElementById('nameDispB').innerText=liveMatch.nB;
            document.getElementById('scoreDispA').innerText=POINTS[liveMatch.sA]; document.getElementById('scoreDispB').innerText=POINTS[liveMatch.sB];
            document.getElementById('gamesDispA').innerText=liveMatch.gA; document.getElementById('gamesDispB').innerText=liveMatch.gB;
            if(liveMatch.sA===3&&liveMatch.sB===3) document.getElementById('gpAlert').classList.remove('hidden'); else document.getElementById('gpAlert').classList.add('hidden');
        }
        function endMatch(){
            if(!confirm("Finish?"))return;
            let w='DRAW'; if(liveMatch.gA>liveMatch.gB)w='A'; if(liveMatch.gB>liveMatch.gA)w='B';
            if(w==='DRAW')return alert("Winner needed!");

            if(liveMatch.type === 'friendly') {
                const list = MODE==='solo'?db.solo.players:db.duo.teams;
                const upd=(ids,win,mg,og)=>ids.forEach(id=>{ const x=list.find(i=>i.id==id); if(x){x.matches++; if(win)x.won++; x.gamesWon+=mg; x.gamesLost+=og;} });
                if(Array.isArray(liveMatch.iA)) { upd(liveMatch.iA, w==='A', liveMatch.gA, liveMatch.gB); upd(liveMatch.iB, w==='B', liveMatch.gB, liveMatch.gA); }
                const r={date:new Date().toLocaleDateString(),tA:liveMatch.nA,tB:liveMatch.nB,sc:`${liveMatch.gA}-${liveMatch.gB}`,w:w};
                if(MODE==='solo') db.solo.matches.unshift(r); else db.duo.matches.unshift(r);
            } else {
                // CUP LOGIC (Group or KO)
                if(db.cup.format === 'group') {
                    const group = db.cup.data.find(g => g.matches.find(m => m.id === liveMatch.tmId));
                    const match = group.matches.find(m => m.id === liveMatch.tmId);
                    match.played = true; match.scoreA = liveMatch.gA; match.scoreB = liveMatch.gB; match.winner = w;
                    const pA = group.table.find(p => p.id == match.tA_id); const pB = group.table.find(p => p.id == match.tB_id);
                    pA.played++; pB.played++; pA.gd += (liveMatch.gA - liveMatch.gB); pB.gd += (liveMatch.gB - liveMatch.gA);
                    if(w==='A') { pA.pts+=3; pA.won++; pB.lost++; } else { pB.pts+=3; pB.won++; pA.lost++; }
                } else {
                    // KNOCKOUT LOGIC
                    const match = db.cup.data.find(m => m.id === liveMatch.tmId);
                    match.played = true; match.scoreA = liveMatch.gA; match.scoreB = liveMatch.gB; match.winner = w;
                    
                    // Advance Winner
                    const winId = w==='A' ? match.tA_id : match.tB_id;
                    const winName = w==='A' ? match.tA_name : match.tB_name;
                    
                    if(match.nextMatchId) {
                        const nextM = db.cup.data.find(m => m.id === match.nextMatchId);
                        if(match.nextSlot === 'A') { nextM.tA_id = winId; nextM.tA_name = winName; }
                        else { nextM.tB_id = winId; nextM.tB_name = winName; }
                    } else {
                        alert("CHAMPION: " + winName); // Final winner
                    }
                }
            }
            saveAll(); renderAll(); closeScoreboard();
        }
        function renderHistory(){
            const d=document.getElementById('matchHistory'); d.innerHTML='';
            const m=MODE==='solo'?db.solo.matches:db.duo.matches;
            m.slice(0,5).forEach(x=>{d.innerHTML+=`<div class="glass-card p-2 rounded flex justify-between text-xs mb-1"><div class="text-gray-400 w-2/3 truncate"><span class="${x.w==='A'?'text-white font-bold':''}">${x.tA}</span> vs <span class="${x.w==='B'?'text-white font-bold':''}">${x.tB}</span></div><div class="text-neon font-mono">${x.sc}</div></div>`});
        }

        // --- CUP SYSTEM ---
        function setCupType(t){ cupType=t; document.getElementById('btnTypeGroup').className = t==='group'?'bg-neon text-black py-2 rounded text-xs font-bold border border-gray-700':'bg-gray-800 text-gray-400 py-2 rounded text-xs font-bold border border-gray-700'; document.getElementById('btnTypeKo').className = t==='ko'?'bg-neon text-black py-2 rounded text-xs font-bold border border-gray-700':'bg-gray-800 text-gray-400 py-2 rounded text-xs font-bold border border-gray-700'; if(t==='group'){document.getElementById('configGroup').classList.remove('hidden'); document.getElementById('configKo').classList.add('hidden');} else {document.getElementById('configGroup').classList.add('hidden'); document.getElementById('configKo').classList.remove('hidden');} }
        function setCupSize(n){ cupSize=n; } // Simplification: Visual feedback omitted for brevity
        
        function createTournament(){
            const name = document.getElementById('cupName').value;
            const checkboxes = document.querySelectorAll('#cupParticipants input:checked');
            const pIds = Array.from(checkboxes).map(c => parseInt(c.value));
            const list = MODE==='solo'?db.solo.players:db.duo.teams;
            
            if(pIds.length < 2) return alert("Select participants!");
            if(cupType === 'ko' && pIds.length !== cupSize) return alert(`Knockout needs exactly ${cupSize} participants.`);

            const shuffled = pIds.sort(() => 0.5 - Math.random());
            let cupData = [];

            if(cupType === 'group') {
                // Group Logic
                for(let i=0; i<cupSize; i++) cupData.push({name: String.fromCharCode(65+i), table:[], matches:[]});
                shuffled.forEach((pid, idx) => {
                    const gIdx = idx % cupSize;
                    const entName = list.find(x=>x.id===pid).name;
                    cupData[gIdx].table.push({id:pid, name:entName, played:0, won:0, lost:0, gd:0, pts:0});
                });
                // Fixtures
                cupData.forEach(g => {
                    const t = g.table;
                    for(let i=0; i<t.length; i++)
                        for(let j=i+1; j<t.length; j++)
                            g.matches.push({ id: Date.now()+Math.random(), tA_id: t[i].id, tA_name: t[i].name, tB_id: t[j].id, tB_name: t[j].name, played: false, scoreA:0, scoreB:0 });
                });
            } else {
                // Knockout Logic (Simple standard bracket)
                // If 4: 2 Semis -> 1 Final
                // If 8: 4 QFs -> 2 Semis -> 1 Final
                const totalMatches = cupSize - 1;
                const rounds = Math.log2(cupSize);
                
                let matchIdCounter = 1;
                // Generate Round 1
                for(let i=0; i<cupSize; i+=2) {
                    const p1 = list.find(x=>x.id===shuffled[i]);
                    const p2 = list.find(x=>x.id===shuffled[i+1]);
                    cupData.push({
                        id: matchIdCounter++, 
                        round: 1, 
                        tA_id: p1.id, tA_name: p1.name, 
                        tB_id: p2.id, tB_name: p2.name, 
                        played: false, scoreA:0, scoreB:0,
                        nextMatchId: null, nextSlot: null 
                    });
                }
                
                // Generate subsequent rounds
                let currentRoundMatches = cupSize / 2;
                let roundNum = 2;
                let prevRoundStartId = 1;
                
                while(currentRoundMatches > 1) { // Until Final
                    currentRoundMatches /= 2;
                    for(let i=0; i<currentRoundMatches; i++) {
                        const newId = matchIdCounter++;
                        cupData.push({
                            id: newId, round: roundNum,
                            tA_id: null, tA_name: 'TBD', tB_id: null, tB_name: 'TBD',
                            played: false, scoreA:0, scoreB:0, nextMatchId: null
                        });
                        // Link previous matches to this one
                        const m1 = cupData.find(m => m.id === prevRoundStartId + (i*2));
                        const m2 = cupData.find(m => m.id === prevRoundStartId + (i*2) + 1);
                        m1.nextMatchId = newId; m1.nextSlot = 'A';
                        m2.nextMatchId = newId; m2.nextSlot = 'B';
                    }
                    prevRoundStartId += (currentRoundMatches * 2);
                    roundNum++;
                }
            }

            db.cup = { name: name, format: cupType, data: cupData };
            saveAll(); renderCup();
        }

        function renderCup(){
            if(!db.cup) { document.getElementById('cupSetup').classList.remove('hidden'); document.getElementById('cupActive').classList.add('hidden'); return; }
            document.getElementById('cupSetup').classList.add('hidden'); document.getElementById('cupActive').classList.remove('hidden');
            document.getElementById('activeCupName').innerText = db.cup.name;
            document.getElementById('activeCupType').innerText = db.cup.format === 'group' ? 'GROUP STAGE' : 'KNOCKOUT';

            const c = document.getElementById('cupContent'); c.innerHTML='';
            
            if(db.cup.format === 'group') {
                db.cup.data.forEach(g => {
                    g.table.sort((a,b) => b.pts - a.pts || b.gd - a.gd);
                    let rows = ''; g.table.forEach((p,i) => { rows += `<tr class="${i<2?'bg-white/5':''}"> <td class="text-center text-gray-500">${i+1}</td> <td class="text-left font-bold text-white truncate max-w-[80px]">${p.name}</td> <td>${p.played}</td><td>${p.won}</td><td>${p.gd}</td> <td class="font-bold text-neon">${p.pts}</td> </tr>`; });
                    let fix = ''; g.matches.forEach(m => { const st = m.played ? `<span class="text-neon font-mono">${m.scoreA}-${m.scoreB}</span>` : `<button onclick="startMatch('cup', ${m.id})" class="text-[9px] bg-gray-700 px-2 rounded hover:bg-white hover:text-black">PLAY</button>`; fix += `<div class="flex justify-between items-center py-1 border-b border-gray-800"><div class="text-[10px] text-gray-400 w-2/3 truncate">${m.tA_name} vs ${m.tB_name}</div><div>${st}</div></div>`; });
                    c.innerHTML += `<div class="glass-panel p-4 rounded-xl mb-6"><div class="text-neon font-sport font-bold text-xl mb-2">GROUP ${g.name}</div><table class="w-full cup-table mb-4"><thead><tr><th>#</th><th class="text-left">TEAM</th><th>P</th><th>W</th><th>GD</th><th>PTS</th></tr></thead><tbody>${rows}</tbody></table><div class="bg-black/20 p-2 rounded"><div class="text-[9px] text-gray-500 font-bold uppercase mb-2">FIXTURES</div>${fix}</div></div>`;
                });
            } else {
                // RENDER KNOCKOUT
                const matches = db.cup.data;
                const maxRound = Math.max(...matches.map(m => m.round));
                
                for(let r=1; r<=maxRound; r++) {
                    const roundMatches = matches.filter(m => m.round === r);
                    let title = r === maxRound ? "FINAL" : (r === maxRound-1 ? "SEMI FINALS" : "QUARTER FINALS");
                    
                    let mHtml = '';
                    roundMatches.forEach(m => {
                        const status = m.played ? `<span class="text-neon font-bold text-lg">${m.scoreA} - ${m.scoreB}</span>` : (m.tA_id && m.tB_id ? `<button onclick="startMatch('cup', ${m.id})" class="bg-neon text-black font-bold px-3 py-1 rounded text-xs">PLAY</button>` : `<span class="text-gray-600 text-xs">WAITING</span>`);
                        const winClassA = m.winner === 'A' ? 'text-neon' : 'text-white';
                        const winClassB = m.winner === 'B' ? 'text-neon' : 'text-white';
                        
                        mHtml += `
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 mb-3 relative">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold ${winClassA}">${m.tA_name}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold ${winClassB}">${m.tB_name}</span>
                            </div>
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">${status}</div>
                        </div>`;
                    });

                    c.innerHTML += `<div class="mb-4"><div class="text-center text-electric font-bold text-sm mb-2 tracking-widest">${title}</div>${mHtml}</div>`;
                }
            }
        }

        function deleteCup(){ if(confirm("End Tournament?")) { db.cup=null; saveAll(); renderCup(); } }

        // --- RANK & EXPORT ---
        let topEnt=null;
        function renderRank(){
            const b=document.getElementById('rankBody'); b.innerHTML='';
            const l=MODE==='solo'?db.solo.players:db.duo.teams;
            const s=[...l].sort((a,b)=>(b.won-a.won)||(b.gamesWon-b.gamesLost)-(a.gamesWon-a.gamesLost));
            topEnt=s[0]||null;
            if(topEnt&&topEnt.matches>0){document.getElementById('mvpHeader').classList.remove('hidden'); document.getElementById('leaderName').innerText=topEnt.name;}
            else document.getElementById('mvpHeader').classList.add('hidden');
            s.forEach((x,i)=>{ const d=x.gamesWon-x.gamesLost; b.innerHTML+=`<tr class="hover:bg-white/5 border-b border-gray-800/50"><td class="p-4 text-center text-gray-500">${i===0?'<i class="fas fa-crown text-yellow-400"></i>':i+1}</td><td class="p-4 font-bold text-white truncate max-w-[100px] font-sport text-lg">${x.name}</td><td class="p-4 text-center text-gray-500">${x.matches}</td><td class="p-4 text-center text-neon font-bold">${x.won}</td><td class="p-4 text-right text-gray-400">${d>0?'+'+d:d}</td></tr>`;});
        }
        function openExport(){
            if(!topEnt)return;
            document.getElementById('cardAppTitle').innerText = document.getElementById('appTitle').innerText.replace(/\n/g," ");
            document.getElementById('expName').innerText=topEnt.name; document.getElementById('expWin').innerText=topEnt.won; document.getElementById('expMatch').innerText=topEnt.matches;
            document.getElementById('expRate').innerText=(topEnt.matches>0?Math.round((topEnt.won/topEnt.matches)*100):0)+'%';
            document.getElementById('exportModal').classList.remove('hidden');
        }
        function closeExport(){document.getElementById('exportModal').classList.add('hidden');}
        function loadPhoto(i){if(i.files&&i.files[0]){const r=new FileReader(); r.onload=(e)=>document.getElementById('cardPhoto').style.backgroundImage=`url('${e.target.result}')`; r.readAsDataURL(i.files[0]);}}
        function downloadCard(){html2canvas(document.getElementById('cardCanvas'),{scale:3,backgroundColor:null}).then(c=>{const a=document.createElement('a'); a.download='MVP.png'; a.href=c.toDataURL('image/png'); a.click();});}
    </script>
</body>
</html>
