<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARCH - Padel Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        padel: '#ccff00', 
                        darkbg: '#0a0a0a',
                        cardbg: '#141414',
                        cardhover: '#1a1a1a'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            color: #e0e0e0; 
            background-color: #0a0a0a;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3Cdefs%3E%3Cpattern id='grid' width='40' height='40' patternUnits='userSpaceOnUse'%3E%3Cpath d='M 40 0 L 0 0 0 40' fill='none' stroke='%23222' stroke-width='0.5'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23grid)'/%3E%3C/svg%3E");
            background-attachment: fixed;
        }
        .tab-active { border-bottom: 2px solid #ccff00; color: #ccff00; }
        .glass-panel { background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(8px); border: 1px solid rgba(50,50,50,0.5); }
        .reclub-table th { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; color: #666; font-weight: 600; padding-bottom: 8px;}
        .reclub-table td { padding: 0.8rem 0.5rem; border-bottom: 1px solid #222; }
        .score-input { background: #000; border: 1px solid #333; color: white; text-align: center; font-family: monospace; }
        .score-input:focus { border-color: #ccff00; outline: none; }
        select { -webkit-appearance: none; appearance: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pb-20 relative overflow-x-hidden">
    
    <header class="w-full max-w-lg p-5 flex justify-between items-end bg-darkbg/90 sticky top-0 z-50 border-b border-gray-800 backdrop-blur-md">
        <div>
            <h1 class="text-3xl font-black tracking-tighter text-white italic">PARCH</h1>
            <div class="h-1 w-10 bg-padel mb-1"></div>
            <p class="text-[0.65rem] text-padel font-bold tracking-[0.3em] uppercase">Padel Architect</p>
        </div>
        <button onclick="resetData()" class="text-xs text-red-800 hover:text-red-500 transition flex items-center gap-1">
            <i class="fas fa-trash-alt"></i> Reset
        </button>
    </header>

    <div class="w-full max-w-lg flex justify-around bg-darkbg/95 pt-3 sticky top-[85px] z-40 border-b border-gray-800 shadow-sm">
        <button onclick="switchTab('players')" id="tab-players" class="flex-1 pb-3 text-sm font-bold text-gray-500 tab-active transition-all uppercase tracking-wider"><i class="fas fa-users mr-2"></i>Players</button>
        <button onclick="switchTab('match')" id="tab-match" class="flex-1 pb-3 text-sm font-bold text-gray-500 transition-all uppercase tracking-wider"><i class="fas fa-table-tennis mr-2"></i>Arena</button>
        <button onclick="switchTab('leaderboard')" id="tab-leaderboard" class="flex-1 pb-3 text-sm font-bold text-gray-500 transition-all uppercase tracking-wider"><i class="fas fa-trophy mr-2"></i>Ranking</button>
    </div>

    <main class="w-full max-w-lg p-4 space-y-6 mt-2">

        <section id="view-players" class="block animate-fade">
            <div class="glass-panel p-4 rounded-xl mb-4 shadow-lg shadow-black/20 border-l-4 border-padel">
                <label class="text-xs text-padel font-bold uppercase tracking-wider mb-2 block">Daftar Architect</label>
                <div class="flex gap-2">
                    <input type="text" id="playerName" placeholder="Nama Pemain..." class="flex-1 bg-black/50 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-padel placeholder-gray-600">
                    <button onclick="addPlayer()" class="bg-padel text-black font-bold px-5 rounded-lg hover:bg-white transition-colors">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2 text-right"><span id="playerCount" class="text-padel">0</span>/50 Terdaftar</p>
            </div>

            <div id="playerList" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1">
                </div>
        </section>

        <section id="view-match" class="hidden">
            
            <div class="flex p-1 bg-gray-900 rounded-lg mb-6 border border-gray-800">
                <button onclick="setMatchMode('auto')" id="mode-auto" class="flex-1 py-2 text-xs font-bold uppercase tracking-wider rounded-md bg-gray-800 text-white shadow-sm transition-all">Fair Generator</button>
                <button onclick="setMatchMode('manual')" id="mode-manual" class="flex-1 py-2 text-xs font-bold uppercase tracking-wider rounded-md text-gray-500 hover:text-white transition-all">Manual Pick</button>
            </div>

            <div id="panel-auto" class="glass-panel p-5 rounded-xl mb-8 border-t-2 border-padel shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 text-padel opacity-10">
                    <i class="fas fa-balance-scale fa-4x"></i>
                </div>
                <h3 class="text-sm font-black italic text-white mb-4 flex items-center">
                    <i class="fas fa-robot text-padel mr-2"></i>FAIR PLAY GENERATOR
                </h3>
                <div class="flex items-end gap-3">
                    <div class="flex-1">
                         <label class="block text-[10px] text-gray-400 mb-1 font-bold uppercase">Jumlah Match</label>
                         <input type="number" id="matchCountInput" min="1" value="4" class="w-full bg-black/50 border border-gray-700 rounded-lg px-4 py-3 text-center text-white font-bold text-lg focus:outline-none focus:border-padel">
                    </div>
                    <button onclick="generateQueueMatches()" class="flex-[2] bg-padel text-black font-black tracking-wider py-3 rounded-xl hover:bg-white transition flex items-center justify-center h-[54px]">
                        <i class="fas fa-bolt mr-2"></i> ACAK MERATA
                    </button>
                </div>
                <p class="text-[10px] text-gray-500 mt-3 leading-tight">*Sistem akan memprioritaskan pemain dengan jumlah main paling sedikit agar semua rata.</p>
            </div>

            <div id="panel-manual" class="hidden glass-panel p-5 rounded-xl mb-8 border-t-2 border-blue-500 shadow-lg">
                <h3 class="text-sm font-black italic text-white mb-4 flex items-center">
                    <i class="fas fa-hand-pointer text-blue-500 mr-2"></i>CUSTOM MATCH
                </h3>
                
                <div class="grid grid-cols-2 gap-4 mb-4 relative">
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="bg-black border border-gray-700 rounded-full w-8 h-8 flex items-center justify-center text-[10px] font-black text-gray-500 z-10">VS</div>
                    </div>

                    <div class="space-y-2">
                        <div class="text-[10px] text-blue-400 font-bold text-center">TEAM BLUE</div>
                        <select id="man_p1" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-xs text-white focus:border-blue-500"></select>
                        <select id="man_p2" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-xs text-white focus:border-blue-500"></select>
                    </div>

                    <div class="space-y-2">
                        <div class="text-[10px] text-red-400 font-bold text-center">TEAM RED</div>
                        <select id="man_p3" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-xs text-white focus:border-red-500"></select>
                        <select id="man_p4" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-xs text-white focus:border-red-500"></select>
                    </div>
                </div>

                <button onclick="addManualMatch()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition uppercase tracking-wider text-xs">
                    <i class="fas fa-plus-circle mr-2"></i> Tambahkan ke Arena
                </button>
            </div>

            <div id="activeMatchesList" class="space-y-8 min-h-[100px]">
                </div>

            <div class="mt-12 border-t border-gray-800 pt-6">
                <h4 class="text-xs font-bold text-gray-500 mb-4 uppercase tracking-widest flex items-center">
                    <i class="fas fa-history mr-2"></i> Riwayat Selesai
                </h4>
                <div id="matchHistory" class="space-y-3">
                    </div>
            </div>
        </section>

        <section id="view-leaderboard" class="hidden">
            <div class="glass-panel rounded-2xl overflow-hidden shadow-lg shadow-black/30 border-t-4 border-gray-700">
                <div class="p-4 bg-darkbg/50 border-b border-gray-800 flex justify-between items-center">
                    <h3 class="font-black italic text-lg">ARCHITECT RANKING</h3>
                    <i class="fas fa-crown text-padel/50"></i>
                </div>
                <table class="w-full text-left reclub-table">
                    <thead class="bg-[#0f0f0f]">
                        <tr>
                            <th class="pl-4 text-center w-10">#</th>
                            <th>Architect</th>
                            <th class="text-center">Play</th>
                            <th class="text-center text-padel">Pts</th>
                            <th class="text-center">%Win</th>
                            <th class="text-right pr-4">Diff</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        </tbody>
                </table>
            </div>
            <p class="text-[10px] text-gray-500 text-center mt-4">Pts: 1 Poin per Kemenangan Match. Diff: Selisih Total Game.</p>
        </section>

    </main>

    <div id="exportContainer" style="position: absolute; top: -9999px; left: -9999px; width: 450px;"></div>


    <script>
        // --- DATA & STATE ---
        let players = JSON.parse(localStorage.getItem('parch_players')) || [];
        let matches = JSON.parse(localStorage.getItem('parch_matches')) || [];
        let activeMatchesData = JSON.parse(localStorage.getItem('parch_active')) || [];

        // --- INIT ---
        loadInitialData();

        function loadInitialData() {
            renderPlayers();
            renderLeaderboard();
            renderHistory();
            renderActiveMatches();
            updateCount();
            populateManualSelects();
        }

        // --- FUNCTIONS: NAVIGATION & MODES ---
        function switchTab(tabName) {
            ['players', 'match', 'leaderboard'].forEach(t => {
                document.getElementById('view-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('tab-active', 'text-padel');
            });
            document.getElementById('view-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('tab-active', 'text-padel');
            if(tabName === 'match') populateManualSelects();
            window.scrollTo(0,0);
        }

        function setMatchMode(mode) {
            if(mode === 'auto') {
                document.getElementById('panel-auto').classList.remove('hidden');
                document.getElementById('panel-manual').classList.add('hidden');
                document.getElementById('mode-auto').classList.add('bg-gray-800', 'text-white');
                document.getElementById('mode-auto').classList.remove('text-gray-500');
                document.getElementById('mode-manual').classList.remove('bg-gray-800', 'text-white');
                document.getElementById('mode-manual').classList.add('text-gray-500');
            } else {
                document.getElementById('panel-auto').classList.add('hidden');
                document.getElementById('panel-manual').classList.remove('hidden');
                document.getElementById('mode-manual').classList.add('bg-gray-800', 'text-white');
                document.getElementById('mode-manual').classList.remove('text-gray-500');
                document.getElementById('mode-auto').classList.remove('bg-gray-800', 'text-white');
                document.getElementById('mode-auto').classList.add('text-gray-500');
                populateManualSelects();
            }
        }

        // --- FUNCTIONS: PLAYERS ---
        function addPlayer() {
            const input = document.getElementById('playerName');
            const name = input.value.trim();
            if (!name) return alert("Nama tidak boleh kosong!");
            if (players.find(p => p.name.toLowerCase() === name.toLowerCase())) return alert("Nama sudah ada!");

            const newPlayer = {
                id: Date.now(),
                name: name,
                matches: 0, won: 0, lost: 0, gamesWon: 0, gamesLost: 0
            };

            players.push(newPlayer);
            saveData();
            renderPlayers();
            renderLeaderboard();
            input.value = '';
            updateCount();
        }

        function removePlayer(id) {
            if(confirm('Hapus pemain ini? Data statistik akan hilang.')) {
                players = players.filter(p => p.id !== id);
                saveData();
                renderPlayers();
                renderLeaderboard();
                updateCount();
            }
        }

        function renderPlayers() {
            const list = document.getElementById('playerList');
            list.innerHTML = '';
            players.slice().reverse().forEach(p => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-cardbg hover:bg-cardhover p-3 rounded-lg border border-gray-800/50 transition group';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-md bg-gradient-to-br from-gray-800 to-black flex items-center justify-center text-xs font-black text-padel border border-gray-700">
                            ${p.name.substring(0,2).toUpperCase()}
                        </div>
                        <span class="font-bold text-sm">${p.name}</span>
                    </div>
                    <button onclick="removePlayer(${p.id})" class="text-gray-700 opacity-0 group-hover:opacity-100 hover:text-red-500 transition px-2"><i class="fas fa-times"></i></button>
                `;
                list.appendChild(div);
            });
        }

        function updateCount() {
            document.getElementById('playerCount').innerText = players.length;
        }

        // --- FUNCTIONS: MATCH GENERATION (FAIR PLAY) ---
        
        function generateQueueMatches() {
            const countInput = document.getElementById('matchCountInput');
            const count = parseInt(countInput.value) || 1;
            
            if (players.length < 4) return alert("Butuh minimal 4 pemain!");

            // 1. Buat data sementara (Snapshot kondisi sekarang)
            // Menghitung: Jumlah Main Selesai (history) + Jumlah Main yg Sedang Mengantri
            let tempPlayerStats = players.map(p => ({
                id: p.id,
                name: p.name,
                // Count active matches (queued) + completed matches
                projectedCount: p.matches + getActiveMatchCountForPlayer(p.id)
            }));

            // Loop untuk membuat beberapa match sekaligus
            for(let i = 0; i < count; i++) {
                
                // 2. Sorting: Prioritas yang MAIN PALING SEDIKIT (Ascending)
                // Jika jumlah main sama, maka diacak (Random)
                tempPlayerStats.sort((a, b) => {
                    if (a.projectedCount !== b.projectedCount) {
                        return a.projectedCount - b.projectedCount; // Utamakan yang mainnya sedikit
                    }
                    return 0.5 - Math.random(); // Kalau sama, acak
                });

                // 3. Ambil 4 Orang teratas (yang paling kurang main)
                const selectedStats = tempPlayerStats.slice(0, 4);
                
                // Acak pasangan tim dari 4 orang terpilih ini (agar tidak selalu bareng teman yang sama)
                const shuffledTop4 = selectedStats.sort(() => 0.5 - Math.random());

                // 4. Update data sementara (anggap mereka sudah main 1x lagi)
                // Agar di loop berikutnya mereka tidak dipilih lagi jika masih ada yg lebih sedikit
                tempPlayerStats.forEach(p => {
                    if(shuffledTop4.find(s => s.id === p.id)) {
                        p.projectedCount++;
                    }
                });

                // 5. Masukkan ke Antrian Real
                const teamA = [getPlayerById(shuffledTop4[0].id), getPlayerById(shuffledTop4[1].id)];
                const teamB = [getPlayerById(shuffledTop4[2].id), getPlayerById(shuffledTop4[3].id)];
                addActiveMatchToData(teamA, teamB);
            }

            renderActiveMatches();
            document.getElementById('activeMatchesList').scrollIntoView({ behavior: 'smooth' });
        }

        // Helper: Hitung berapa kali pemain ada di daftar antrian (activeMatches)
        function getActiveMatchCountForPlayer(pid) {
            let count = 0;
            activeMatchesData.forEach(m => {
                if(m.teamA.find(p=>p.id===pid) || m.teamB.find(p=>p.id===pid)) count++;
            });
            return count;
        }

        function getPlayerById(pid) {
            return players.find(p => p.id === pid);
        }

        // --- MANUAL MATCH BUILDER ---
        function populateManualSelects() {
            const selects = ['man_p1', 'man_p2', 'man_p3', 'man_p4'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="">Pilih...</option>';
                players.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                    sel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            });
        }

        function addManualMatch() {
            const p1Id = document.getElementById('man_p1').value;
            const p2Id = document.getElementById('man_p2').value;
            const p3Id = document.getElementById('man_p3').value;
            const p4Id = document.getElementById('man_p4').value;

            if(!p1Id || !p2Id || !p3Id || !p4Id) return alert("Pilih 4 pemain!");
            
            const selectedIds = [p1Id, p2Id, p3Id, p4Id];
            const uniqueIds = new Set(selectedIds);
            if(uniqueIds.size !== 4) return alert("Pemain tidak boleh sama dalam satu match!");

            const getP = (id) => players.find(p => p.id == id);
            
            addActiveMatchToData(
                [getP(p1Id), getP(p2Id)], 
                [getP(p3Id), getP(p4Id)]
            );
            
            renderActiveMatches();
            // Reset selects
            ['man_p1', 'man_p2', 'man_p3', 'man_p4'].forEach(id => document.getElementById(id).value = "");
        }

        // Core Helper: Add to State
        function addActiveMatchToData(teamA, teamB) {
            const matchId = Date.now() + Math.floor(Math.random() * 1000);
            const matchNum = matches.length + activeMatchesData.length + 1; // Total match number
            
            activeMatchesData.push({
                id: matchId,
                matchLabel: `Match #${matchNum}`,
                teamA: teamA,
                teamB: teamB
            });
            saveData();
        }

        // --- RENDER ACTIVE MATCHES ---
        function renderActiveMatches() {
            const container = document.getElementById('activeMatchesList');
            container.innerHTML = '';

            if(activeMatchesData.length === 0) return;

            // Title Divider
            container.innerHTML = `<div class="text-center text-xs text-padel font-bold uppercase tracking-[0.2em] mb-4 relative opacity-70"><span class="bg-darkbg px-4 relative z-10">Antrian Arena</span><div class="absolute top-1/2 left-0 w-full h-px bg-padel/30 -z-0"></div></div>`;

            activeMatchesData.forEach((match, index) => {
                const matchCard = document.createElement('div');
                matchCard.id = `match-card-${match.id}`;
                matchCard.className = 'glass-panel rounded-xl overflow-hidden border border-gray-700 mb-6 shadow-lg shadow-black/40 relative animate-fade';
                
                matchCard.innerHTML = `
                <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-transparent to-gray-800/30 -z-10 rounded-bl-full"></div>
                
                <div class="bg-[#111] p-2 flex justify-between items-center border-b border-gray-800">
                     <div class="text-xs text-gray-400 font-bold uppercase tracking-widest"><i class="fas fa-gamepad text-padel mr-1"></i> ${match.matchLabel || 'Match'}</div>
                     <button onclick="deleteActiveMatch(${match.id})" class="text-xs text-red-900 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="p-4 relative">
                    <div class="flex justify-between relative z-20 gap-4">
                        <div class="flex-1 text-left bg-gradient-to-r from-blue-900/10 to-transparent p-3 rounded-l-lg border-l-2 border-blue-500">
                            <div class="text-blue-500 font-black text-[10px] mb-1 tracking-wider">TEAM BLUE</div>
                            <div class="font-bold text-sm truncate">${match.teamA[0].name}</div>
                            <div class="font-bold text-sm truncate">${match.teamA[1].name}</div>
                        </div>

                        <div class="flex flex-col justify-center items-center">
                            <span class="text-gray-600 font-black text-xs italic">VS</span>
                        </div>

                        <div class="flex-1 text-right bg-gradient-to-l from-red-900/10 to-transparent p-3 rounded-r-lg border-r-2 border-red-500">
                            <div class="text-red-500 font-black text-[10px] mb-1 tracking-wider">TEAM RED</div>
                             <div class="font-bold text-sm truncate">${match.teamB[0].name}</div>
                            <div class="font-bold text-sm truncate">${match.teamB[1].name}</div>
                        </div>
                    </div>

                    <div class="mt-4 space-y-1 bg-black/40 p-3 rounded-lg border border-gray-800">
                        <div class="grid grid-cols-7 gap-1 text-center text-[9px] text-gray-500 mb-1 font-bold">
                            <div class="col-span-1"></div>
                            <div class="col-span-2">SET 1</div>
                            <div class="col-span-2">SET 2</div>
                            <div class="col-span-2">SET 3</div>
                        </div>
                        <div class="grid grid-cols-7 gap-2 items-center">
                            <span class="text-blue-400 font-black text-[10px] col-span-1">BLUE</span>
                            <input type="number" id="sA1_${match.id}" class="score-input rounded p-2 col-span-2" placeholder="-">
                            <input type="number" id="sA2_${match.id}" class="score-input rounded p-2 col-span-2" placeholder="-">
                            <input type="number" id="sA3_${match.id}" class="score-input rounded p-2 col-span-2" placeholder="-">
                        </div>
                        <div class="grid grid-cols-7 gap-2 items-center mt-1">
                            <span class="text-red-400 font-black text-[10px] col-span-1">RED</span>
                            <input type="number" id="sB1_${match.id}" class="score-input rounded p-2 col-span-2" placeholder="-">
                            <input type="number" id="sB2_${match.id}" class="score-input rounded p-2 col-span-2" placeholder="-">
                            <input type="number" id="sB3_${match.id}" class="score-input rounded p-2 col-span-2" placeholder="-">
                        </div>
                    </div>

                    <button onclick="submitMatchScore(${match.id})" class="w-full mt-4 bg-white text-black font-black tracking-wider py-3 rounded-lg hover:bg-padel hover:text-black transition-colors shadow-md text-xs uppercase">
                        <i class="fas fa-check-circle mr-1"></i> Submit Score
                    </button>
                </div>`;
                container.appendChild(matchCard);
            });
        }

        function deleteActiveMatch(id) {
            if(confirm("Batalkan match ini?")) {
                activeMatchesData = activeMatchesData.filter(m => m.id !== id);
                saveData();
                renderActiveMatches();
            }
        }

        function submitMatchScore(matchId) {
            const matchData = activeMatchesData.find(m => m.id === matchId);
            if(!matchData) return;

            const a1 = parseInt(document.getElementById(`sA1_${matchId}`).value) || 0;
            const b1 = parseInt(document.getElementById(`sB1_${matchId}`).value) || 0;
            const a2 = parseInt(document.getElementById(`sA2_${matchId}`).value) || 0;
            const b2 = parseInt(document.getElementById(`sB2_${matchId}`).value) || 0;
            const a3 = parseInt(document.getElementById(`sA3_${matchId}`).value) || 0;
            const b3 = parseInt(document.getElementById(`sB3_${matchId}`).value) || 0;

            if (a1 === 0 && b1 === 0) return alert("Masukkan skor minimal Set 1");

            let setsA = 0, setsB = 0;
            let totalGamesA = a1 + a2 + a3;
            let totalGamesB = b1 + b2 + b3;

            if (a1 > b1) setsA++; else if (b1 > a1) setsB++;
            if (a2 > 0 || b2 > 0) { if (a2 > b2) setsA++; else if (b2 > a2) setsB++; }
            if (a3 > 0 || b3 > 0) { if (a3 > b3) setsA++; else if (b3 > a3) setsB++; }

            let winnerTeam = null;
            if (setsA > setsB) winnerTeam = 'A';
            else if (setsB > setsA) winnerTeam = 'B';
            else return alert("Skor Imbang? Tentukan pemenang set terakhir.");

            // Update Stats
            const updateStats = (player, wonMatch, gamesWon, gamesLost) => {
                const pIndex = players.findIndex(x => x.id === player.id);
                if (pIndex > -1) {
                    players[pIndex].matches++;
                    if (wonMatch) players[pIndex].won++; else players[pIndex].lost++;
                    players[pIndex].gamesWon += gamesWon;
                    players[pIndex].gamesLost += gamesLost;
                }
            };

            const isAWinner = winnerTeam === 'A';
            matchData.teamA.forEach(p => updateStats(p, isAWinner, totalGamesA, totalGamesB));
            matchData.teamB.forEach(p => updateStats(p, !isAWinner, totalGamesB, totalGamesA));

            // Save History
            const scoreStr = `${a1}-${b1}` + (a2+b2>0 || a3+b3>0 ? ` | ${a2}-${b2}` : '') + (a3+b3>0 ? ` | ${a3}-${b3}` : '');
            
            const matchRecord = {
                id: matchId,
                date: new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }),
                teamA: matchData.teamA.map(p => p.name),
                teamB: matchData.teamB.map(p => p.name),
                scoreStr: scoreStr,
                winner: winnerTeam,
                sets: `${setsA}-${setsB}`
            };
            matches.unshift(matchRecord);

            // Remove from active
            activeMatchesData = activeMatchesData.filter(m => m.id !== matchId);

            saveData();
            renderActiveMatches();
            renderHistory();
            renderLeaderboard();
        }

        // --- EXPORT & HISTORY ---
        function renderHistory() {
            const container = document.getElementById('matchHistory');
            container.innerHTML = '';
            if(matches.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-600 text-xs italic">Belum ada pertandingan.</p>';
                 return;
            }

            matches.slice(0, 15).forEach(m => {
                const div = document.createElement('div');
                const exportId = `history-item-${m.id}`;
                div.id = exportId;
                div.className = 'bg-cardbg hover:bg-[#1a1a1a] border border-gray-800/60 rounded-xl p-3 text-sm flex flex-col gap-2 transition relative overflow-hidden group';
                
                const teamAClass = m.winner === 'A' ? 'text-blue-400 font-black' : 'text-gray-400 font-medium';
                const teamBClass = m.winner === 'B' ? 'text-red-400 font-black' : 'text-gray-400 font-medium';
                
                div.innerHTML = `
                    <div class="flex justify-between items-center pb-2 border-b border-gray-800/50">
                        <span class="text-[10px] text-gray-600 font-mono">${m.date}</span>
                        <span class="text-xs font-bold text-padel tracking-wider">SETS: ${m.sets}</span>
                    </div>
                    <div class="flex justify-between items-center pt-1">
                        <div class="flex-1 space-y-1">
                            <div class="${teamAClass} truncate pr-2">${m.teamA.join(' & ')}</div>
                            <div class="${teamBClass} truncate pr-2">${m.teamB.join(' & ')}</div>
                        </div>
                        <div class="text-right pl-2 border-l border-gray-800">
                            <div class="font-mono text-white font-bold text-sm whitespace-nowrap">${m.scoreStr}</div>
                        </div>
                    </div>
                    <button onclick="exportToPNG('${exportId}')" class="absolute top-2 right-2 text-gray-600 hover:text-padel transition opacity-50 group-hover:opacity-100 p-1">
                        <i class="fas fa-camera"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function exportToPNG(elementId) {
            const sourceElement = document.getElementById(elementId);
            const exportContainer = document.getElementById('exportContainer');
            
            exportContainer.innerHTML = '';
            const clone = sourceElement.cloneNode(true);
            
            clone.style.backgroundColor = '#0a0a0a';
            clone.style.backgroundImage = 'linear-gradient(rgba(10,10,10,0.95), rgba(10,10,10,0.95)), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23333333\' fill-opacity=\'0.2\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")';
            clone.style.padding = '25px';
            clone.style.borderRadius = '16px';
            clone.style.border = '2px solid #ccff00';
            clone.style.width = '100%';
            clone.querySelector('button').style.display = 'none';

            const header = document.createElement('div');
            header.innerHTML = `
                <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
                    <div>
                        <div class="text-white font-black italic text-xl">PARCH</div>
                        <div class="text-padel text-[10px] tracking-[0.3em] font-bold uppercase">Architect Result</div>
                    </div>
                    <i class="fas fa-trophy text-padel text-xl"></i>
                </div>`;
            clone.insertBefore(header, clone.firstChild);

            exportContainer.appendChild(clone);

            html2canvas(clone, { backgroundColor: null, scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `PARCH-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                exportContainer.innerHTML = '';
            });
        }

        function renderLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';

            const sorted = [...players].sort((a, b) => {
                if (b.won !== a.won) return b.won - a.won;
                const wrA = a.matches ? a.won/a.matches : 0;
                const wrB = b.matches ? b.won/b.matches : 0;
                if (wrB !== wrA) return wrB - wrA;
                return (b.gamesWon - b.gamesLost) - (a.gamesWon - a.gamesLost);
            });

            sorted.forEach((p, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-darkbg/30' : 'bg-transparent';
                const winRate = p.matches > 0 ? Math.round((p.won / p.matches) * 100) : 0;
                const diff = p.gamesWon - p.gamesLost;
                
                let rankDisplay = `<span class="text-gray-500 font-mono text-xs">${index + 1}</span>`;
                let rowClass = '';
                if(index === 0) { rankDisplay = `<i class="fas fa-crown text-padel"></i>`; rowClass = 'font-bold'; }
                else if(index === 1) { rankDisplay = `<span class="text-gray-300 font-bold">2</span>`; }
                else if(index === 2) { rankDisplay = `<span class="text-amber-700 font-bold">3</span>`; }

                const diffClass = diff > 0 ? 'text-padel' : (diff < 0 ? 'text-red-400' : 'text-gray-500');

                tr.innerHTML = `
                    <td class="pl-4 text-center py-3 ${rowClass}">${rankDisplay}</td>
                    <td class="font-medium text-white ${rowClass} truncate max-w-[100px]">${p.name}</td>
                    <td class="text-center text-gray-400">${p.matches}</td>
                    <td class="text-center font-black text-padel text-base">${p.won}</td>
                    <td class="text-center text-gray-400 text-xs">${winRate}%</td>
                    <td class="text-right pr-4 text-xs font-mono ${diffClass}">${diff > 0 ? '+'+diff : diff}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveData() {
            localStorage.setItem('parch_players', JSON.stringify(players));
            localStorage.setItem('parch_matches', JSON.stringify(matches));
            localStorage.setItem('parch_active', JSON.stringify(activeMatchesData));
        }

        function resetData() {
            if(confirm("Hapus SEMUA data?")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
